<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaDun Cakes - WhatsApp Order Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: #FFFFFF; /* White background */
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 600px;
            width: 100%;
            background: #FFFFFF; /* Clean white container */
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(46,46,46,0.15); /* Softer shadow with charcoal */
            overflow: hidden;
            border: 1px solid rgba(201,161,60,0.1); /* Subtle gold border */
        }

        .header {
            background: #5f0f40; /* Dark burgundy background */
            color: #FFFFFF; /* White text for better contrast */
            padding: 30px;
            text-align: center;
            border-bottom: 2px solid #C9A13C; /* Metallic gold accent line */
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header-logo {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(201,161,60,0.3); /* Gold shadow */
            border: 2px solid #C9A13C; /* Gold border */
            filter: brightness(0) invert(1); /* Make logo white */
        }

        .header p {
            opacity: 0.8;
            color: #FFFFFF; /* White text for dark background */
        }

        .form-section {
            padding: 30px;
            background: #FFFFFF;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2E2E2E; /* Charcoal grey */
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #BFAEA1; /* Taupe border */
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: #FFFFFF;
            color: #2E2E2E;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #C9A13C; /* Metallic gold focus */
            box-shadow: 0 0 0 3px rgba(201,161,60,0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #C9A13C 0%, #D4AF47 100%); /* Metallic gold gradient */
            color: #2E2E2E; /* Charcoal text */
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s;
        }

        .submit-btn:hover {
            background: linear-gradient(135deg, #BFAEA1 0%, #C9A13C 100%); /* Taupe to gold hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201,161,60,0.3);
        }

        .submit-btn:disabled {
            background: #BFAEA1; /* Taupe disabled state */
            cursor: not-allowed;
            transform: none;
            color: #FFFFFF;
        }

        .setup-section {
            background: #F5F5F5; /* Light gray background */
            border-bottom: 2px solid #BFAEA1; /* Taupe border */
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            overflow: hidden;
        }

        .setup-section.collapsed {
            max-height: 80px;
            padding: 15px 20px 10px 20px; /* Reduced top padding from 20px to 15px */
        }

        .setup-section.expanded {
            max-height: 1200px; /* Increased to fit all content */
            padding: 15px; /* Reduced from 20px */
        }

        .setup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px; /* Reduced from 15px to close the gap */
        }

        .setup-header h3 {
            color: #2E2E2E; /* Charcoal grey */
            margin: 0;
        }

        .toggle-btn {
            background: linear-gradient(135deg, #C9A13C 0%, #D4AF47 100%); /* Metallic gold gradient */
            color: #2E2E2E; /* Charcoal text */
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .toggle-btn:hover {
            background: linear-gradient(135deg, #BFAEA1 0%, #C9A13C 100%); /* Taupe to gold hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201,161,60,0.3);
        }

        .config-content {
            transition: opacity 0.3s ease-out;
        }

        .setup-section.collapsed .config-content {
            opacity: 0;
            pointer-events: none;
        }

        .setup-section.expanded .config-content {
            opacity: 1;
            pointer-events: auto;
        }

        .orders-section {
            background: #FFFFFF; /* Clean white background */
            padding: 20px;
            border-top: 2px solid #C9A13C; /* Gold accent line */
        }

        .orders-section h2 {
            color: #2E2E2E; /* Charcoal grey */
            margin-bottom: 20px;
            text-align: center;
        }

        .order-card {
            background: #F8C9CC; /* Soft blush background */
            padding: 20px;
            border: 1px solid #BFAEA1; /* Taupe border */
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(46,46,46,0.1);
            border-left: 4px solid #C9A13C; /* Gold accent */
        }

        .order-card h3 {
            color: #2E2E2E; /* Charcoal grey */
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-card p {
            margin: 5px 0;
            color: #2E2E2E; /* Charcoal grey */
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-completed {
            background: #C9A13C; /* Metallic gold */
            color: #2E2E2E; /* Charcoal text */
        }

        .status-pending {
            background: #BFAEA1; /* Taupe */
            color: #2E2E2E; /* Charcoal text */
        }

        .follow-up-btn {
            background: #C9A13C; /* Metallic gold */
            color: #2E2E2E; /* Charcoal text */
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .follow-up-btn:hover {
            background: #BFAEA1; /* Taupe hover */
            color: #FFFFFF;
        }

        .follow-up-btn:disabled {
            background: #BFAEA1; /* Taupe disabled */
            cursor: not-allowed;
            color: #FFFFFF;
        }

        .guide-section {
            background: #FFFFFF; /* Clean white background */
            padding: 20px;
            border-top: 2px solid #C9A13C; /* Gold accent line */
        }

        .guide-section h2 {
            color: #2E2E2E; /* Charcoal grey */
            margin-bottom: 20px;
        }

        .guide-content {
            display: block; /* Changed from grid to block for full width */
        }

        .guide-card {
            background: #F8C9CC; /* Soft blush background */
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(46,46,46,0.1);
            border-left: 4px solid #C9A13C; /* Gold accent */
            border: 1px solid #BFAEA1; /* Taupe border */
            font-size: 0.85em; /* Smaller base font size */
        }

        .guide-card h3 {
            color: #2E2E2E; /* Charcoal grey */
            margin-bottom: 20px;
            font-size: 1.1em; /* Reduced from 1.3em */
        }

        .guide-card h4 {
            color: #2E2E2E; /* Charcoal grey */
            margin: 20px 0 10px 0;
            font-size: 0.95em; /* Reduced from 1.1em */
            border-bottom: 1px solid #BFAEA1; /* Taupe border */
            padding-bottom: 5px;
        }

        .guide-card ul, .guide-card ol {
            margin: 10px 0 15px 20px;
            line-height: 1.4; /* Reduced line height for compactness */
            font-size: 0.9em; /* Smaller text for lists */
        }

        .guide-card li {
            margin-bottom: 3px; /* Reduced spacing between items */
        }

        .guide-card p {
            font-size: 0.9em; /* Smaller paragraph text */
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .guide-card code {
            background: #f1f1f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.8em; /* Reduced from 0.9em */
        }

        .guide-card pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #e9ecef;
        }

        .guide-card pre code {
            background: none;
            padding: 0;
        }

        .setup-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .setup-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
        }

        .status.success {
            background: #C9A13C; /* Metallic gold background */
            color: #2E2E2E; /* Charcoal text */
            border: 1px solid #BFAEA1; /* Taupe border */
        }

        .status.error {
            background: #BFAEA1; /* Taupe background for errors */
            color: #2E2E2E; /* Charcoal text */
            border: 1px solid #C9A13C; /* Gold border */
        }

        .spinner {
            border: 3px solid #F8C9CC; /* Soft blush */
            border-top: 3px solid #C9A13C; /* Metallic gold */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Anniversary Management Styles */
        .anniversary-card {
            background: #FFFFFF;
            border: 2px solid #F8C9CC;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .anniversary-card:hover {
            transform: translateY(-2px);
        }

        .anniversary-card.ready {
            border-color: #C9A13C;
            background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
        }

        .anniversary-card.skipped {
            border-color: #BFAEA1;
            background: #f5f5f5;
            opacity: 0.7;
        }

        .countdown-timer {
            font-size: 1.2em;
            font-weight: 600;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
        }

        .countdown-ready {
            background: linear-gradient(135deg, #C9A13C 0%, #D4AF47 100%);
            color: #2E2E2E;
        }

        .countdown-waiting {
            background: #F8C9CC;
            color: #5f0f40;
        }

        /* Pulse animation for ready-to-send countdowns */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .anniversary-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .anniversary-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .anniversary-btn:disabled {
            cursor: not-allowed !important;
            opacity: 0.5 !important;
            background: #6c757d !important;
            color: #aaa !important;
        }

        .anniversary-btn:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        .send-anniversary-btn {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
        }

        .send-anniversary-btn:hover {
            background: linear-gradient(135deg, #8e44ad 0%, #7d3c98 100%);
            transform: translateY(-2px);
        }

        .skip-anniversary-btn {
            background: #BFAEA1;
            color: #2E2E2E;
        }

        .skip-anniversary-btn:hover {
            background: #a89890;
        }

        .anniversary-status {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            text-align: center;
        }

        .status-sent {
            background: #d4edda;
            color: #155724;
        }

        .status-skipped {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 600px) {
            .setup-row {
                grid-template-columns: 1fr;
            }
            
            .anniversary-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <img src="image/Logo.png" alt="Logo" class="header-logo">
                <div style="text-align: center;">
                    <div>Ladun Cakes</div>
                    <div style="font-size: 0.6em; margin-top: 5px;">WhatsApp Order Manager</div>
                </div>
            </h1>
            <p></p>
        </div>

        <!-- Mobile Warning -->
        <div id="mobileWarning" style="display: none; background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; margin: 10px 20px; border-radius: 8px; text-align: center;">
            <strong>üì± Mobile Friendly:</strong> This app works perfectly on mobile! All messages sent via WhatsApp for instant delivery.
        </div>

        <!-- Test Mode Toggle -->
        <div class="setup-section collapsed" id="setupSection">
            <div class="setup-header" style="justify-content: center;">
                <button class="toggle-btn" onclick="toggleSetup()" id="toggleBtn">
                    Show Settings
                </button>
            </div>
            <div class="config-content" id="configContent">
                <div style="padding: 15px;">
                    <!-- Test Mode -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="testMode" onchange="toggleTestMode()" style="width: 18px; height: 18px;"> 
                            <span>üß™ <strong>Test Mode</strong> - Anniversary in 1 minute (Testing)</span>
                        </label>
                    </div>
                    
                    <!-- Cloud Sync Section -->
                    <div style="padding-top: 15px; border-top: 2px dashed #C9A13C;">
                        <h4 style="color: #2E2E2E; margin-bottom: 10px;">‚òÅÔ∏è Cloud Sync</h4>
                                <!-- Reset Local Data button removed: all data is now cloud-based -->
                                </button>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Backup & sync data across devices via Google Sheets.</p>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 12px; font-weight: 600;">Google Sheets API URL:</label>
                            <input type="text" id="googleSheetsUrl" placeholder="https://script.google.com/macros/s/.../exec" style="width: 100%; padding: 8px; border: 2px solid #BFAEA1; border-radius: 5px; font-size: 12px; margin-top: 5px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <button onclick="testCloudConnection()" style="padding: 10px 16px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                üîå Test Connection
                            </button>
                            <button onclick="saveCloudConfig()" style="padding: 10px 16px; background: #C9A13C; color: #2E2E2E; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                üíæ Save URL
                            </button>
                        </div>
                        
                        <button onclick="syncToCloud()" id="syncBtn" style="padding: 12px 16px; background: linear-gradient(135deg, #C9A13C 0%, #D4AF47 100%); color: #2E2E2E; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%;">
                            üîÑ Sync Now
                        </button>
                        
                        <div id="syncStatus" style="margin-top: 10px; padding: 10px; border-radius: 5px; font-size: 12px; display: none;"></div>
                        
                        <div style="margin-top: 10px; font-size: 11px; color: #888;">
                            <span id="lastSyncTime">Last sync: Never</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Form Section -->
        <div class="form-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Order Details</h2>
            </div>
            
            <form id="orderForm">
                <div class="form-group">
                    <label for="customerName">Customer Name *</label>
                    <input type="text" id="customerName" required placeholder="Enter customer name">
                </div>

                <div class="form-group">
                    <label for="customerPhone">Customer Phone (WhatsApp) *</label>
                    <input type="tel" id="customerPhone" required placeholder="e.g., +1234567890 or 1234567890">
                    <small style="color: #666; font-size: 0.8em;">Required for WhatsApp messages. Include country code for international numbers.</small>
                </div>

                <div class="form-group">
                    <label for="cakeType">Cake Type</label>
                    <select id="cakeType">
                        <option value="Birthday Cake">Birthday Cake</option>
                        <option value="Wedding Cake">Wedding Cake</option>
                        <option value="Anniversary Cake">Anniversary Cake</option>
                        <option value="Custom Cake">Custom Cake</option>
                        <option value="Cupcakes">Cupcakes</option>
                        <option value="Celebration Cake">Celebration Cake</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="orderDetails">Special Requests & Order Details</label>
                    <textarea id="orderDetails" placeholder="Flavor, size, design preferences, decorations, colors, etc."></textarea>
                </div>

                <div class="form-group">
                    <label for="collectionDate">Collection Date *</label>
                    <input type="date" id="collectionDate" required>
                </div>

                <div class="form-group">
                    <label for="collectionTime">Collection Time *</label>
                    <input type="time" id="collectionTime" required>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    Save Order üéÇ
                </button>
            </form>

            <div id="statusMessage" class="status" style="display: none;"></div>
        </div>

        <!-- Anniversary Management Section -->
        <div class="orders-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h4>üìÖ Anniversary Email Management</h4>
                <button onclick="toggleAnniversaryManager()" class="toggle-btn" id="anniversaryToggleBtn">
                    Show Anniversary Manager
                </button>
            </div>
            
            <div id="anniversaryManager" style="display: none;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p><strong>üí° How it works:</strong> This shows all orders with anniversary countdown timers. Send anniversary emails manually for better customer retention, or mark as "Skip" if you don't want to contact that customer.</p>
                </div>
                <div id="anniversaryOrdersList"></div>
            </div>
        </div>

        <!-- Past Orders Section -->
        <div class="orders-section" id="ordersSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üìã Recent Orders</h2>
                <button onclick="clearAllOrders()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                    üóëÔ∏è Clear All Orders
                </button>
            </div>
            <div id="ordersList"></div>
        </div>
    </div>

    <script>
        let orders = [];
        let testMode = false;

        // Load saved configuration
        function loadConfig() {

            // No local orders: will fetch from cloud

            // Load config settings including test mode
            const config = JSON.parse(localStorage.getItem('miniAppConfig') || '{}');
            if (config.testMode !== undefined) {
                document.getElementById('testMode').checked = config.testMode;
            }
            
            // Load legacy test mode if new config doesn't exist
            const savedTestMode = localStorage.getItem('testMode');
            if (savedTestMode && config.testMode === undefined) {
                testMode = JSON.parse(savedTestMode);
                document.getElementById('testMode').checked = testMode;
                // Migrate to new config structure
                config.testMode = testMode;
                localStorage.setItem('miniAppConfig', JSON.stringify(config));
            }
        }

        // Clear all orders function
        function clearAllOrders() {
            if (confirm('Are you sure you want to delete ALL orders? This cannot be undone.')) {
                orders = [];
                showStatus('üóëÔ∏è All orders cleared locally. Please sync to update cloud.', 'info');
            }
        }

        // Toggle test mode for quick anniversary testing
        function toggleTestMode() {
            const testModeCheckbox = document.getElementById('testMode');
            const config = JSON.parse(localStorage.getItem('miniAppConfig') || '{}');
            config.testMode = testModeCheckbox.checked;
            localStorage.setItem('miniAppConfig', JSON.stringify(config));
            
            // Recalculate anniversary dates for all orders when toggling test mode
            orders.forEach(order => {
                if (order.thankYouSent && order.thankYouSentTime) {
                    if (config.testMode) {
                        // Test mode: 1 minute after collection notice sent
                        const anniversaryDate = new Date(order.thankYouSentTime);
                        anniversaryDate.setMinutes(anniversaryDate.getMinutes() + 1);
                        order.anniversaryDate = anniversaryDate.toISOString();
                    } else {
                        // Normal mode: 323 days after collection date
                        const collectionDate = new Date(order.collectionDate + 'T12:00:00');
                        const anniversaryDate = new Date(collectionDate);
                        anniversaryDate.setDate(anniversaryDate.getDate() + 323);
                        order.anniversaryDate = anniversaryDate.toISOString();
                    }
                }
            });
            // No localStorage for orders
            // displayOrders() will be called after cloud sync
            
            if (config.testMode) {
                showStatus('üß™ Test Mode ON: Anniversary emails available 1 minute after collection notice is sent', 'success');
            } else {
                showStatus('üìÖ Test Mode OFF: Anniversary emails available 323 days after collection', 'success');
            }

            // Also refresh anniversary manager if it's open
            const manager = document.getElementById('anniversaryManager');
            if (manager.style.display !== 'none') {
                displayAnniversaryOrders();
            }
        }

        // Toggle setup section visibility
        function toggleSetup() {
            const setupSection = document.getElementById('setupSection');
            const toggleBtn = document.getElementById('toggleBtn');
            
            if (setupSection.classList.contains('collapsed')) {
                setupSection.classList.remove('collapsed');
                setupSection.classList.add('expanded');
                toggleBtn.textContent = 'Hide Config';
            } else {
                setupSection.classList.remove('expanded');
                setupSection.classList.add('collapsed');
                toggleBtn.textContent = 'Show Config';
            }
        }
        // Show status message
        function showStatus(message, type, autoHide = true) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
            statusDiv.style.display = 'block';
            
            if (autoHide) {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('collectionDate').min = today;

        // Handle form submission
        document.getElementById('orderForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner"></div> Saving Order...';

            // Validate required fields
            const collectionDate = document.getElementById('collectionDate').value;
            const collectionTime = document.getElementById('collectionTime').value;
            if (!collectionDate || !collectionTime) {
                showStatus('‚ùå Please enter both collection date and time.', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Save Order üéÇ';
                return;
            }

            // Always fetch latest cloud orders before creating a new order
            fetch(DEFAULT_GOOGLE_SHEETS_URL + '?action=getOrders', {
                method: 'GET',
                mode: 'cors'
            })
            .then(response => response.json())
            .then(data => {
                if (data.orders) {
                    orders = data.orders;
                }
                // Get form data
                const orderData = {
                    customerName: document.getElementById('customerName').value,
                    customerPhone: document.getElementById('customerPhone').value,
                    cakeType: document.getElementById('cakeType').value,
                    orderDetails: document.getElementById('orderDetails').value || 'No special requests',
                    collectionDate: collectionDate,
                    collectionTime: collectionTime,
                    orderDate: new Date().toLocaleDateString()
                };

                // Generate order number in format YYYYMM_XX
                const now = new Date();
                const yearMonth = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}`;
                // Find the highest order number for this month
                const currentMonthOrders = orders.filter(o => 
                    typeof o.id === 'string' && o.id.startsWith(yearMonth)
                );
                let nextNumber = 1;
                if (currentMonthOrders.length > 0) {
                    const numbers = currentMonthOrders.map(o => {
                        const parts = o.id.split('_');
                        return parts.length > 1 ? parseInt(parts[1]) : 0;
                    });
                    nextNumber = Math.max(...numbers) + 1;
                }
                const orderId = `${yearMonth}_${String(nextNumber).padStart(2, '0')}`;
                // Store the order
                const order = {
                    id: orderId,
                    customerName: orderData.customerName,
                    customerPhone: orderData.customerPhone,
                    cakeType: orderData.cakeType,
                    orderDetails: orderData.orderDetails,
                    collectionDate: collectionDate,
                    collectionTime: collectionTime,
                    orderDate: new Date().toLocaleDateString(),
                    thankYouSent: '',
                    whatsappSent: '',
                    anniversarySent: '',
                    anniversaryWhatsappSent: ''
                };
                orders.unshift(order);
                showStatus('‚è≥ Syncing new order to cloud...', 'info');
                syncToCloud().then(() => {
                    showStatus(`üéÇ Order saved and synced for ${orderData.customerName}! You can send WhatsApp messages when ready.`, 'success');
                    // Reset form
                    document.getElementById('orderForm').reset();
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Save Order üéÇ';
                });
            })
            .catch(err => {
                showStatus('‚ùå Failed to fetch latest cloud orders. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Save Order üéÇ';
            });
        });

        // Display orders function
        function displayOrders() {
            const ordersSection = document.getElementById('ordersSection');
            const ordersList = document.getElementById('ordersList');
            // Debug: log all orders
            console.log('All loaded orders:', orders);
            // Show all orders where thankYouSent, anniversarySent, or anniversarySkipped is blank (pending)
            const visibleOrders = orders.filter(order => {
                const isThankYouPending = !order.thankYouSent || order.thankYouSent === '' || order.thankYouSent === false || order.thankYouSent === 'FALSE';
                const isAnnivPending = order.thankYouSent === 'Sent' && (!order.anniversarySent || order.anniversarySent === '' || order.anniversarySent === false || order.anniversarySent === 'FALSE') && (!order.anniversarySkipped || order.anniversarySkipped === '' || order.anniversarySkipped === false || order.anniversarySkipped === 'FALSE');
                return isThankYouPending || isAnnivPending;
            });
            if (visibleOrders.length === 0) {
                ordersSection.style.display = 'none';
                return;
            }
            ordersSection.style.display = 'block';
            ordersList.innerHTML = visibleOrders.map(order => {
                const collectionDate = new Date(order.collectionDate + 'T23:59:59'); // End of collection day
                const now = new Date();
                const isPastCollection = now > collectionDate;
                
                // Manual "Cake is Ready" button - always available until sent (unless collection day passed)
                const isReadyToSend = !isPastCollection && !order.thankYouSent;
                
                // Calculate anniversary date
                let anniversaryDate;
                const testMode = config.testMode || false;
                
                // Use stored anniversary date if available, otherwise calculate it
                if (order.anniversaryDate) {
                    anniversaryDate = new Date(order.anniversaryDate);
                } else {
                    // Fallback calculation for older orders
                    if (testMode) {
                        // Test mode: 1 minute after collection time
                        if (order.collectionDate && order.collectionTime) {
                            anniversaryDate = new Date(order.collectionDate + 'T' + order.collectionTime);
                            anniversaryDate.setMinutes(anniversaryDate.getMinutes() + 1);
                        } else {
                            // Fallback: 1 minute from now
                            anniversaryDate = new Date();
                            anniversaryDate.setMinutes(anniversaryDate.getMinutes() + 1);
                        }
                    } else {
                        // Normal mode: 323 days after collection
                        anniversaryDate = new Date(collectionDate);
                        anniversaryDate.setDate(anniversaryDate.getDate() + 323); // 323 days after collection
                    }
                }
                
                // Anniversary is available manually - no automatic sending
                const isAnniversaryTime = collectionDate <= now && !order.anniversarySent;
                
                return `
                    <div class="order-card">
                        <h3>
                            ${order.customerName} - ${order.cakeType}
                            <span class="status-badge ${order.whatsappSent ? 'status-completed' : 'status-pending'}">
                                ${order.whatsappSent ? 'Order Confirmed' : 'Pending'}
                            </span>
                        </h3>
                        <p><strong>ÔøΩ Phone:</strong> ${order.customerPhone || 'Not provided'}</p>
                        <p><strong>üéÇ Cake Type:</strong> ${order.cakeType}</p>
                        <p><strong>üìÖ Collection:</strong> ${formatDate(order.collectionDate)} at ${order.collectionTime}</p>
                        <p><strong>üìù Details:</strong> ${order.orderDetails || 'No special requests'}</p>
                        <p><strong>üìÜ Order Date:</strong> ${order.orderDate}</p>
                        <p><strong>üéâ Anniversary:</strong> ${testMode ? 
                            `${anniversaryDate.toLocaleString()} (TEST MODE - 1 min)` : 
                            formatDate(anniversaryDate.toISOString().split('T')[0])
                        }</p>
                        
                        <div style="margin-top: 15px;">
                            ${isReadyToSend ? `
                                ${order.customerPhone ? `
                                    <button 
                                        class="follow-up-btn" 
                                        onclick="sendCollectionWhatsApp('${order.id}')"
                                        style="background: #25d366; margin-right: 10px; color: white;">
                                        üí¨ Send Collection WhatsApp
                                    </button>
                                ` : '<span style="color: #999;">‚ö†Ô∏è No phone number</span>'}
                            ` : order.whatsappSent ? `
                                <span style="color: #28a745; font-weight: bold;">‚úÖ Collection Notice Sent</span>
                            ` : isPastCollection ? `
                                <span style="color: #999; font-style: italic;">‚è∞ Collection date passed</span>
                            ` : ''}
                            
                            ${order.whatsappSent && isAnniversaryTime && !order.anniversarySkipped ? `
                                ${order.customerPhone ? `
                                    <button 
                                        class="follow-up-btn" 
                                        onclick="sendAnniversaryWhatsApp('${order.id}')"
                                        style="background: #25d366; margin-right: 10px; color: white;">
                                        üí¨ Send Anniversary WhatsApp
                                    </button>
                                ` : '<span style="color: #999;">‚ö†Ô∏è No phone number</span>'}
                            ` : order.anniversaryWhatsappSent ? `
                                <span style="color: #9b59b6; font-weight: bold; margin-left: 10px;">‚úÖ Anniversary Sent</span>
                            ` : order.anniversarySkipped ? `
                                <span style="color: #666; font-style: italic; margin-left: 10px;">‚ùå Anniversary Skipped</span>
                            ` : order.whatsappSent ? `
                                <span style="color: #666; font-style: italic; margin-left: 10px;">
                                    üéÇ Anniversary available: ${formatDate(anniversaryDate.toISOString().split('T')[0])}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Format date function
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('en-GB', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // WhatsApp Message Templates
        function getOrderConfirmationMessage(order) {
            return `Dear ${order.customerName},

Thank you so much for choosing Ladun Cakes! We're thrilled to be part of your special celebration. ‚ú®

Your order has been received and we'll begin creating your beautiful ${order.cakeType} with the finest ingredients, artistry, and care.

Order Details
‚Ä¢ Cake Type: ${order.cakeType}
‚Ä¢ Collection Date: ${formatDate(order.collectionDate)}
‚Ä¢ Collection Time: ${order.collectionTime}
${order.orderDetails && order.orderDetails !== 'No special requests' ? `‚Ä¢ Special Requests: ${order.orderDetails}` : ''}

We'll send you another message when your cake is ready for collection.

Stay connected with us:

üì∏ Follow us on Instagram: https://www.instagram.com/laduncakes
üéµ Watch us on TikTok: https://www.tiktok.com/@laduncakes
üëç Like us on Facebook: https://www.facebook.com/share/178PimAdRz/?mibextid=wwXIfr

With love,
Ladun Cakes`;
        }

        function getCollectionMessage(order) {
            return `Dear ${order.customerName},

Thank you so much for choosing Ladun Cakes to be part of your special day. It's been an absolute pleasure creating something truly beautiful for your celebration.

Your cake has been lovingly handcrafted and here are your order details.

Order Details
‚Ä¢ Cake Type: ${order.cakeType}
‚Ä¢ Collection Date: ${formatDate(order.collectionDate)}
‚Ä¢ Collection Time: ${order.collectionTime}
${order.orderDetails && order.orderDetails !== 'No special requests' ? `‚Ä¢ Special Requests & Order Details: ${order.orderDetails}` : ''}

Each of our cakes is created with the finest ingredients, artistry, and care ‚Äî designed to bring a touch of elegance and joy to your most meaningful moments. We can't wait for you to see (and taste!) your gorgeous cake. ‚ú®

We'd love for you to stay connected ‚Äî follow us on social media and share your experience. Your kind words and photos mean so much to us.

Follow us on Instagram: https://www.instagram.com/laduncakes
Watch us on TikTok: https://www.tiktok.com/@laduncakes
Like us on Facebook: https://www.facebook.com/share/178PimAdRz/?mibextid=wwXIfr
Google Review: https://g.page/r/Cbv3t2r3bnosEAE/review
Website: https://laduncakes.co.uk/

With love,
Ladun Cakes`;
        }

        function getAnniversaryMessage(order) {
            return `Dear ${order.customerName},

We hope you've been doing beautifully. As we celebrate the anniversary of your special day, we wanted to take a moment to send our warmest wishes your way. ‚ú®

It was such a joy to create your ${order.cakeType} on ${formatDate(order.collectionDate)}, and we'd love to be part of your celebrations again ‚Äî this time, with a bespoke Ladun Cake made especially for your upcoming occasions.

Each of our cakes is handcrafted with care, artistry, and a touch of elegance ‚Äî perfect for making your day as memorable (and delicious!) as it deserves to be.

You can place your order easily by contacting us, and we'll handle every detail with love.

Stay connected with us and see our latest creations:

Follow us on Instagram: https://www.instagram.com/laduncakes
Watch us on TikTok: https://www.tiktok.com/@laduncakes
Like us on Facebook: https://www.facebook.com/share/178PimAdRz/?mibextid=wwXIfr

With love and sweet wishes,
Ladun Cakes`;
        }

        // WhatsApp Functions
        function sendCollectionWhatsApp(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            if (!order.customerPhone) {
                showStatus('‚ùå No phone number provided for this customer.', 'error');
                return;
            }

            // Clean phone number (remove spaces, dashes, etc.)
            const cleanPhone = order.customerPhone.replace(/[^\d+]/g, '');
            
            // Get message from template
            const message = getCollectionMessage(order);

            // Create WhatsApp URL - works better on mobile
            const cleanPhoneForUrl = cleanPhone.startsWith('+') ? cleanPhone.substring(1) : cleanPhone;
            const whatsappUrl = `https://wa.me/${cleanPhoneForUrl}?text=${encodeURIComponent(message)}`;
            
            // Try multiple methods to open WhatsApp (better mobile compatibility)
            try {
                // First try: window.location for better mobile support
                window.location.href = whatsappUrl;
            } catch (e) {
                // Fallback: window.open
                window.open(whatsappUrl, '_blank');
            }
            
            showStatus(`üí¨ Collection WhatsApp opened for ${order.customerName}!`, 'success');
            
            // Mark as sent and calculate anniversary date
            order.whatsappSent = 'Sent';
            order.whatsappSentTime = new Date().toISOString();
            // Also update thankYouSent for cloud sync compatibility
            order.thankYouSent = 'Sent';
            order.thankYouSentTime = order.whatsappSentTime;
            
            // Calculate and store the anniversary date
            const config = JSON.parse(localStorage.getItem('miniAppConfig') || '{}');
            const testMode = config.testMode || false;
            
            if (testMode) {
                // Test mode: 1 minute after collection notice sent
                const anniversaryDate = new Date();
                anniversaryDate.setMinutes(anniversaryDate.getMinutes() + 1);
                order.anniversaryDate = anniversaryDate.toISOString();
            } else {
                // Normal mode: 323 days after collection date
                const collectionDate = new Date(order.collectionDate + 'T12:00:00');
                const anniversaryDate = new Date(collectionDate);
                anniversaryDate.setDate(anniversaryDate.getDate() + 323);
                order.anniversaryDate = anniversaryDate.toISOString();
            }
            
            // No localStorage
            // Sync to cloud after sending collection WhatsApp
            showStatus('‚è≥ Syncing collection WhatsApp status to cloud...', 'info');
            syncToCloud().then(() => {
                showStatus('‚úÖ Collection WhatsApp sent and synced!', 'success');
            });
        }

        function sendAnniversaryWhatsApp(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            if (!order.customerPhone) {
                showStatus('‚ùå No phone number provided for this customer.', 'error');
                return;
            }

            // Clean phone number
            const cleanPhone = order.customerPhone.replace(/[^\d+]/g, '');
            
            // Get message from template
            const message = getAnniversaryMessage(order);

            // Create WhatsApp URL - works better on mobile
            const cleanPhoneForUrl = cleanPhone.startsWith('+') ? cleanPhone.substring(1) : cleanPhone;
            const whatsappUrl = `https://wa.me/${cleanPhoneForUrl}?text=${encodeURIComponent(message)}`;
            
            // Try multiple methods to open WhatsApp (better mobile compatibility)
            try {
                // First try: window.location for better mobile support
                window.location.href = whatsappUrl;
            } catch (e) {
                // Fallback: window.open
                window.open(whatsappUrl, '_blank');
            }
            
            // Mark as sent
            order.anniversaryWhatsappSent = 'Sent';
            order.anniversarySent = 'Sent'; // For cloud sync compatibility
            order.anniversarySentDate = new Date().toLocaleString();
            // No localStorage
            // Sync to cloud after sending anniversary WhatsApp
            showStatus('‚è≥ Syncing anniversary WhatsApp status to cloud...', 'info');
            syncToCloud().then(() => {
                showStatus(`üéâ Anniversary WhatsApp sent and synced for ${order.customerName}!`, 'success');
            });
        }

        // Auto-refresh anniversary management every 5 seconds to update countdowns
        let anniversaryRefreshInterval;

        function startAnniversaryAutoRefresh() {
            if (anniversaryRefreshInterval) {
                clearInterval(anniversaryRefreshInterval);
            }
            
            // Load config to check if we're in test mode
            const config = JSON.parse(localStorage.getItem('miniAppConfig') || '{}');
            const testMode = config.testMode || false;
            
            // Refresh more frequently in test mode for better countdown accuracy
            const refreshInterval = testMode ? 1000 : 5000; // 1 second in test mode, 5 seconds in normal mode
            
            anniversaryRefreshInterval = setInterval(() => {
                const anniversaryManager = document.getElementById('anniversaryManager');
                if (anniversaryManager && anniversaryManager.style.display !== 'none') {
                    displayAnniversaryOrders();
                }
            }, refreshInterval);
        }

        function stopAnniversaryAutoRefresh() {
            if (anniversaryRefreshInterval) {
                clearInterval(anniversaryRefreshInterval);
                anniversaryRefreshInterval = null;
            }
        }

        // Anniversary Management Functions
        function toggleAnniversaryManager() {
            const manager = document.getElementById('anniversaryManager');
            const btn = document.getElementById('anniversaryToggleBtn');
            
            if (manager.style.display === 'none') {
                manager.style.display = 'block';
                btn.textContent = 'Hide Anniversary Manager';
                displayAnniversaryOrders();
                startAnniversaryAutoRefresh(); // Start auto-refresh when opened
            } else {
                manager.style.display = 'none';
                btn.textContent = 'Show Anniversary Manager';
                stopAnniversaryAutoRefresh(); // Stop auto-refresh when closed
            }
        }

        function displayAnniversaryOrders() {
            const container = document.getElementById('anniversaryOrdersList');
            const now = new Date();
            
            // Load config to check test mode
            const config = JSON.parse(localStorage.getItem('miniAppConfig') || '{}');
            const testMode = config.testMode || false;
            
            if (orders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No orders found. Add some orders to see anniversary management.</p>';
                return;
            }

            // Filter and sort orders by collection date
            // Helper to normalize boolean or 'TRUE'/'FALSE' string
            function isSent(val) {
                return val === 'Sent';
            }
            function isSkipped(val) {
                return val === 'Skipped';
            }
            function isPending(val) {
                return !val || val === '';
            }
            const ordersWithAnniversary = orders
                .filter(order => isSent(order.whatsappSent) && isPending(order.anniversarySkipped) && isPending(order.anniversarySent))
                .map(order => {
                    let anniversaryDate;
                    
                    // Use stored anniversary date if available, otherwise calculate it
                    if (order.anniversaryDate) {
                        anniversaryDate = new Date(order.anniversaryDate);
                    } else {
                        // Fallback calculation for older orders without stored anniversary date
                        if (testMode) {
                            // In test mode, anniversary is 1 minute after collection notice was sent via WhatsApp
                            if (order.whatsappSentTime) {
                                anniversaryDate = new Date(order.whatsappSentTime);
                                anniversaryDate.setMinutes(anniversaryDate.getMinutes() + 1);
                            } else {
                                // Fallback: 1 minute from now
                                anniversaryDate = new Date();
                                anniversaryDate.setMinutes(anniversaryDate.getMinutes() + 1);
                            }
                        } else {
                            // Normal mode: 323 days after collection date
                            const collectionDate = new Date(order.collectionDate + 'T12:00:00');
                            anniversaryDate = new Date(collectionDate);
                            anniversaryDate.setDate(anniversaryDate.getDate() + 323);
                        }
                    }
                    
                    const timeDiff = anniversaryDate - now;
                    const daysRemaining = testMode ? 
                        Math.ceil(timeDiff / (1000 * 60)) : // Minutes for test mode
                        Math.ceil(timeDiff / (1000 * 60 * 60 * 24)); // Days for normal mode
                    
                    // Debug log for troubleshooting
                    console.log(`Order ${order.id}: testMode=${testMode}, timeDiff=${timeDiff}, daysRemaining=${daysRemaining}, anniversaryDate=${anniversaryDate}, isReady=${daysRemaining <= 0}`);
                    
                    return {
                        ...order,
                        anniversaryDate,
                        daysRemaining,
                        isReady: daysRemaining <= 0,
                        isPastDue: testMode ? daysRemaining < -2 : daysRemaining < -30, // 2 minutes or 30 days
                        isTestMode: testMode
                    };
                })
                .sort((a, b) => a.daysRemaining - b.daysRemaining); // Sort by days remaining (ready first)

            if (ordersWithAnniversary.length === 0) {
                const totalWithCollection = orders.filter(order => order.whatsappSent).length;
                const skippedCount = orders.filter(order => order.anniversarySkipped).length;
                const sentCount = orders.filter(order => order.anniversarySent).length;
                
                if (totalWithCollection === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No orders with collection WhatsApp sent yet. Send collection WhatsApp first to see anniversary management.</p>';
                } else if (skippedCount + sentCount === totalWithCollection) {
                    container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">All anniversaries have been processed (sent or skipped). Create new orders to see more anniversary management.</p>';
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No pending anniversaries at this time.</p>';
                }
                return;
            }

            // Calculate stats from all orders (not just the filtered ones)
            const allOrdersWithCollection = orders.filter(order => order.whatsappSent);
            const readyToSend = ordersWithAnniversary.filter(o => o.isReady && !o.anniversarySent).length;
            const alreadySent = allOrdersWithCollection.filter(o => o.anniversarySent).length;
            const skipped = allOrdersWithCollection.filter(o => o.anniversarySkipped).length;
            const waiting = ordersWithAnniversary.filter(o => !o.isReady && !o.anniversarySent).length;

            const statsHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #C9A13C 0%, #D4AF47 100%); color: #2E2E2E; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold;">${readyToSend}</div>
                        <div>Ready to Send</div>
                    </div>
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold;">${alreadySent}</div>
                        <div>Already Sent</div>
                    </div>
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold;">${skipped}</div>
                        <div>Skipped</div>
                    </div>
                    <div style="background: #F8C9CC; color: #5f0f40; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold;">${waiting}</div>
                        <div>Still Waiting</div>
                    </div>
                </div>
            `;

            container.innerHTML = statsHtml + ordersWithAnniversary.map(order => {
                const statusClass = order.anniversarySent ? 'sent' : order.anniversarySkipped ? 'skipped' : order.isReady ? 'ready' : 'waiting';
                // Card color logic:
                // - Due (ready to send): green border, light green bg
                // - Not sent, not due (waiting): yellow border, light yellow bg
                let cardStyle = '';
                if (order.isReady) {
                    cardStyle = 'border: 3px solid #25d366; background: linear-gradient(135deg, #f0fff4 0%, #d4f4dd 100%); box-shadow: 0 0 15px rgba(37, 211, 102, 0.3);';
                } else {
                    cardStyle = 'border: 2px solid #ffe066; background: #fffbe6;';
                }
                
                // Calculate detailed countdown with days, hours, minutes
                function formatDetailedCountdown(anniversaryDate, isTestMode) {
                    const now = new Date();
                    const timeDiff = anniversaryDate - now;
                    const isPast = timeDiff < 0;
                    const absTimeDiff = Math.abs(timeDiff);
                    
                    if (isTestMode) {
                        // Test mode - show in minutes/seconds
                        const totalMinutes = Math.floor(absTimeDiff / (1000 * 60));
                        const seconds = Math.floor((absTimeDiff % (1000 * 60)) / 1000);
                        
                        if (totalMinutes > 0) {
                            return `${totalMinutes}m ${seconds}s`;
                        } else {
                            return `${seconds}s`;
                        }
                    } else {
                        // Normal mode - show days, hours, minutes
                        const days = Math.floor(absTimeDiff / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((absTimeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((absTimeDiff % (1000 * 60 * 60)) / (1000 * 60));
                        
                        if (days > 0) {
                            return `${days}d ${hours}h ${minutes}m`;
                        } else if (hours > 0) {
                            return `${hours}h ${minutes}m`;
                        } else {
                            return `${minutes}m`;
                        }
                    }
                }

                const detailedCountdown = formatDetailedCountdown(order.anniversaryDate, order.isTestMode);
                const isReady = order.daysRemaining <= 0;
                const isPastDue = order.isTestMode ? order.daysRemaining < -2 : order.daysRemaining < -30;
                
                let countdownDisplay;
                if (!isReady) {
                    // Still waiting
                    countdownDisplay = `<div class="countdown-timer countdown-waiting">
                        ‚è∞ ${detailedCountdown} until anniversary${order.isTestMode ? ' (TEST MODE)' : ''}
                    </div>`;
                } else if (!isPastDue) {
                    // Ready to send - RED background to make it prominent
                    countdownDisplay = `<div class="countdown-timer countdown-ready" style="background: #dc3545; color: white; font-weight: bold; animation: pulse 2s infinite;">
                        ÔøΩ Anniversary ${order.daysRemaining === 0 ? 'is NOW!' : `was ${detailedCountdown} ago`} - READY TO SEND!${order.isTestMode ? ' (TEST MODE)' : ''}
                    </div>`;
                } else {
                    // Past due
                    countdownDisplay = `<div class="countdown-timer" style="background: #6c757d; color: white;">
                        ‚è≥ Anniversary was ${detailedCountdown} ago - May be too late${order.isTestMode ? ' (TEST MODE)' : ''}
                    </div>`;
                }

                let actionButtons;
                if (order.anniversarySent) {
                    actionButtons = `<div class="anniversary-status status-sent">‚úÖ Anniversary WhatsApp Sent</div>`;
                } else if (order.anniversarySkipped) {
                    actionButtons = `
                        <div class="anniversary-status status-skipped">‚ùå Marked as Skip</div>
                        <button onclick="unSkipAnniversary('${order.id}')" class="anniversary-btn send-anniversary-btn" style="margin-top: 10px;">
                            ‚Ü©Ô∏è Undo Skip
                        </button>
                    `;
                } else {
                    actionButtons = `
                        <div class="anniversary-actions">
                            ${order.customerPhone ? `
                                <button onclick="sendAnniversaryWhatsAppFromManager('${order.id}', this)" 
                                        class="anniversary-btn send-anniversary-btn"
                                        ${!order.isReady ? 'disabled' : ''}
                                        style="${order.isReady ? 'background: #25d366; color: white; font-weight: bold; animation: pulse 2s infinite; font-size: 1.1em; cursor: pointer; margin-right: 10px;' : 'background: #6c757d; color: #aaa; cursor: not-allowed; opacity: 0.5; margin-right: 10px;'}">
                                    ${order.isReady ? 'üí¨ Send WhatsApp NOW' : '‚è≥ Send WhatsApp (Not Ready)'}
                                </button>
                            ` : '<span style="color: #999; font-style: italic; margin-right: 10px;">‚ö†Ô∏è No phone number for WhatsApp</span>'}
                            <button onclick="skipAnniversary('${order.id}')" 
                                    class="anniversary-btn skip-anniversary-btn"
                                    ${!order.isReady ? 'disabled' : ''}
                                    style="${order.isReady ? 'background: #6c757d; color: white; font-weight: bold; cursor: pointer;' : 'background: #6c757d; color: #aaa; cursor: not-allowed; opacity: 0.5;'}">
                                ${order.isReady ? '‚è≠Ô∏è Skip This Customer' : '‚è≥ Skip (Not Ready)'}
                            </button>
                        </div>
                    `;
                }

                return `
                    <div class="anniversary-card ${statusClass}" style="${cardStyle}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="margin: 0; color: #5f0f40;">${order.customerName} - ${order.cakeType}</h3>
                            <span style="font-size: 0.9em; color: #666;">Order #${order.id}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <p><strong>ÔøΩ Phone:</strong> ${order.customerPhone || 'Not provided'}</p>
                                <p><strong>üìÖ Collection Date:</strong> ${formatDate(order.collectionDate)}</p>
                                <p><strong>üéÇ Anniversary Date:</strong> ${formatDate(order.anniversaryDate.toISOString().split('T')[0])}</p>
                            </div>
                            <div>
                                <p><strong>üìù Details:</strong> ${order.orderDetails || 'No special requests'}</p>
                                <p><strong>üìÜ Order Date:</strong> ${order.orderDate}</p>
                            </div>
                        </div>
                        ${countdownDisplay}
                        ${actionButtons}
                    </div>
                `;
            }).join('');
        }

        // WhatsApp Anniversary Manager Function
        function sendAnniversaryWhatsAppFromManager(orderId, buttonElement) {
            console.log('Send anniversary WhatsApp clicked for order:', orderId);
            const orderIdNum = parseInt(orderId);
            
            try {
                // Use the existing sendAnniversaryWhatsApp function
                sendAnniversaryWhatsApp(orderIdNum);
                // Note: The main function handles display updates
            } catch (error) {
                console.error('Error in sendAnniversaryWhatsAppFromManager:', error);
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function skipAnniversary(orderId) {
            if (confirm('Are you sure you want to skip sending anniversary WhatsApp to this customer? You can undo this later.')) {
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    order.anniversarySkipped = 'Skipped';
                    order.anniversarySkippedDate = new Date().toLocaleString();
                    showStatus(`‚ùå Anniversary WhatsApp skipped for ${order.customerName}. Syncing to cloud...`, 'info');
                    syncToCloud().then(() => {
                        showStatus(`‚ùå Anniversary WhatsApp skipped and synced for ${order.customerName}`, 'success');
                    });
                }
            }
        }

        function unSkipAnniversary(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.anniversarySkipped = '';
                order.anniversarySkippedDate = '';
                showStatus(`‚Ü©Ô∏è Anniversary WhatsApp option restored for ${order.customerName}. Syncing to cloud...`, 'info');
                syncToCloud().then(() => {
                    showStatus(`‚Ü©Ô∏è Anniversary WhatsApp option restored and synced for ${order.customerName}`, 'success');
                });
            }
        }

        function sendAnniversaryWhatsAppFromManager(orderId, buttonElement) {
            console.log('Send anniversary WhatsApp clicked for order:', orderId);
            
            try {
                // Use the existing sendAnniversaryWhatsApp function
                sendAnniversaryWhatsApp(orderId);
                // Note: The main function handles display updates
            } catch (error) {
                console.error('Error in sendAnniversaryWhatsAppFromManager:', error);
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Load configuration on page load
        loadConfig();

        // Check if mobile device and show positive message
        function checkMobileDevice() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                document.getElementById('mobileWarning').style.display = 'block';
            }
        }
        checkMobileDevice();

        // Test function - Add a sample order ready for anniversary testing
        function addTestOrder() {
            const testDate = new Date();
            testDate.setDate(testDate.getDate() - 301); // 301 days ago (ready for anniversary)
            
            const testOrder = {
                id: Date.now().toString(),
                customerName: 'Test Customer',
                customerEmail: 'test@example.com',
                cakeType: 'Test Anniversary Cake',
                orderDetails: 'Test order for anniversary email testing',
                collectionDate: testDate.toISOString().split('T')[0],
                collectionTime: '14:00',
                orderDate: testDate.toLocaleDateString(),
                timestamp: testDate.getTime(),
                thankYouSent: 'Sent', // Collection notice already sent
                anniversarySent: '',
                emailSent: 'Sent'
            };
            
            orders.push(testOrder);
            showStatus('üß™ Test order added! Syncing to cloud...', 'info');
            syncToCloud().then(() => {
                showStatus('üß™ Test order added and synced! Check Anniversary Manager to test anniversary emails.', 'success');
                // Auto-open anniversary manager
                setTimeout(() => {
                    toggleAnniversaryManager();
                }, 1000);
            });
        }
        
        // Add test button to console for easy access
        console.log('üß™ To add a test order ready for anniversary email, run: addTestOrder()');

        // Manual-only system - no automatic anniversary emails
        console.log('üéÇ LaDun Cakes Order App loaded - Manual anniversary email system active');

        // ===== GOOGLE SHEETS CLOUD SYNC FUNCTIONS =====

                // Reset Local Data function removed: all data is now cloud-based
        
        // Default Google Sheets API URL (hardcoded for convenience)
        const DEFAULT_GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwQDdxFPdr9pI40TE7dK8inqV5Nybu2H9JtYjizl_8eP1SSUZkvruzS39xBV8gNlQA/exec';
        
        // Load cloud config and orders on startup
        async function loadCloudConfig() {
            const config = JSON.parse(localStorage.getItem('miniAppConfig') || '{}');
            config.googleSheetsUrl = DEFAULT_GOOGLE_SHEETS_URL;
            localStorage.setItem('miniAppConfig', JSON.stringify(config));
            document.getElementById('googleSheetsUrl').value = DEFAULT_GOOGLE_SHEETS_URL;
            const syncBtn = document.getElementById('syncBtn');
            if (syncBtn) syncBtn.disabled = true;
            if (config.lastSync) {
                updateLastSyncDisplay(config.lastSync);
            }
            // Fetch all orders from cloud and populate local orders
            try {
                const response = await fetch(DEFAULT_GOOGLE_SHEETS_URL + '?action=getOrders', {
                    method: 'GET',
                    mode: 'cors'
                });
                const data = await response.json();
                if (data.orders) {
                    orders = data.orders;
                    displayOrders();
                    if (syncBtn) syncBtn.disabled = false;
                } else {
                    showSyncStatus('‚ùå Failed to load cloud orders. Please check your connection.', 'error');
                }
            } catch (e) {
                console.error('Failed to load cloud orders on startup:', e);
                showSyncStatus('‚ùå Failed to load cloud orders. Please check your connection.', 'error');
            }
        }
        
        // Save cloud URL to config
        function saveCloudConfig() {
            const config = JSON.parse(localStorage.getItem('miniAppConfig') || '{}');
            config.googleSheetsUrl = DEFAULT_GOOGLE_SHEETS_URL;
            localStorage.setItem('miniAppConfig', JSON.stringify(config));
            document.getElementById('googleSheetsUrl').value = DEFAULT_GOOGLE_SHEETS_URL;
            showSyncStatus('‚úÖ Google Sheets URL saved!', 'success');
        }
        
        // Test connection to Google Sheets
        async function testCloudConnection() {
            const url = DEFAULT_GOOGLE_SHEETS_URL;
            showSyncStatus('üîÑ Testing connection...', 'info');
            try {
                const response = await fetch(url + '?action=getOrders', {
                    method: 'GET',
                    mode: 'cors'
                });
                const data = await response.json();
                if (data.error) {
                    showSyncStatus('‚ùå Connection failed: ' + data.error, 'error');
                } else {
                    const orderCount = data.orders ? data.orders.length : 0;
                    showSyncStatus(`‚úÖ Connected! Found ${orderCount} orders in cloud.`, 'success');
                }
            } catch (error) {
                console.error('Connection test error:', error);
                showSyncStatus('‚ùå Connection failed: ' + error.message, 'error');
            }
        }
        
        // Sync orders to/from Google Sheets
        async function syncToCloud() {
            // Always fetch latest cloud orders before syncing
            let cloudOrders = [];
            const syncBtn = document.getElementById('syncBtn');
            if (syncBtn) syncBtn.disabled = true;
            try {
                const response = await fetch(DEFAULT_GOOGLE_SHEETS_URL + '?action=getOrders', {
                    method: 'GET',
                    mode: 'cors'
                });
                const data = await response.json();
                if (data.orders) {
                    cloudOrders = data.orders;
                } else {
                    showSyncStatus('‚ùå Failed to fetch latest cloud orders. Sync cancelled.', 'error');
                    if (syncBtn) syncBtn.disabled = false;
                    return;
                }
            } catch (e) {
                console.error('Failed to fetch latest cloud orders before sync:', e);
                showSyncStatus('‚ùå Failed to fetch latest cloud orders. Sync cancelled.', 'error');
                if (syncBtn) syncBtn.disabled = false;
                return;
            }
            // Merge local orders with cloud orders (local takes priority)
            const localOrderIds = new Set(orders.map(o => o.id));
            const mergedOrders = [...orders];
            cloudOrders.forEach(cloudOrder => {
                if (!localOrderIds.has(cloudOrder.id)) {
                    mergedOrders.push(cloudOrder);
                }
            });
            const url = DEFAULT_GOOGLE_SHEETS_URL;
            syncBtn.innerHTML = 'üîÑ Syncing...';
            showSyncStatus('üîÑ Syncing with cloud...', 'info');
            try {
                console.log('Starting sync with', mergedOrders.length, 'orders (merged local + cloud)');
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'syncOrders',
                        orders: mergedOrders
                    })
                });
                console.log('Response status:', response.status);
                const text = await response.text();
                console.log('Response text:', text);
                let data;
                try {
                    data = JSON.parse(text);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError, 'Text:', text);
                    showSyncStatus('‚ùå Sync failed: Invalid response from server', 'error');
                    if (syncBtn) syncBtn.disabled = false;
                    syncBtn.innerHTML = 'üîÑ Sync Now';
                    return;
                }
                if (data.error) {
                    showSyncStatus('‚ùå Sync failed: ' + data.error, 'error');
                } else {
                    // Debug: Log all orders from cloud
                    console.log('DEBUG: Raw cloud orders:', data.orders);
                    function normalizeStatus(val, sentVal = 'Sent', skippedVal = 'Skipped') {
                        if (val === true || val === 'TRUE' || val === sentVal) return sentVal;
                        if (val === false || val === 'FALSE' || val === '' || val == null) return '';
                        if (val === skippedVal) return skippedVal;
                        return val;
                    }
                    const allOrders = (data.orders || []).map(order => ({
                        ...order,
                        whatsappSent: normalizeStatus(order.whatsappSent, 'Sent'),
                        thankYouSent: normalizeStatus(order.thankYouSent, 'Sent'),
                        anniversarySent: normalizeStatus(order.anniversarySent, 'Sent'),
                        anniversarySkipped: normalizeStatus(order.anniversarySkipped, 'Sent', 'Skipped'),
                        anniversaryWhatsappSent: normalizeStatus(order.anniversaryWhatsappSent, 'Sent')
                    }));
                    orders = allOrders;
                    displayOrders();
                    const config = JSON.parse(localStorage.getItem('miniAppConfig') || '{}');
                    config.lastSync = data.lastSync;
                    localStorage.setItem('miniAppConfig', JSON.stringify(config));
                    updateLastSyncDisplay(data.lastSync);
                    showSyncStatus(`‚úÖ Synced! ${allOrders.length} orders in cloud`, 'success');
                    const anniversaryManager = document.getElementById('anniversaryManager');
                    if (anniversaryManager && anniversaryManager.style.display !== 'none') {
                        displayAnniversaryOrders();
                    }
                }
            } catch (error) {
                console.error('Sync error:', error);
                showSyncStatus('‚ùå Sync failed: ' + error.message, 'error');
            } finally {
                if (syncBtn) syncBtn.disabled = false;
                syncBtn.innerHTML = 'üîÑ Sync Now';
            }
        }
        
        // Filter orders to only include those with pending actions
        function filterPendingOrders(allOrders) {
            // Helper to normalize boolean or 'TRUE'/'FALSE' string
            function isSent(val) {
                return val === 'Sent';
            }
            function isSkipped(val) {
                return val === 'Skipped';
            }
            function isPending(val) {
                return !val || val === '';
            }
            return allOrders.filter(order => {
                // If anniversarySkipped is Skipped, order is completed
                if (isSkipped(order.anniversarySkipped)) {
                    return false;
                }
                // Pending if thankYouSent is blank
                if (isPending(order.thankYouSent)) {
                    return true;
                }
                // Pending if thankYouSent is Sent, anniversarySent is blank, and not skipped
                if (isSent(order.thankYouSent) && isPending(order.anniversarySent) && isPending(order.anniversarySkipped)) {
                    return true;
                }
                // Otherwise, completed
                return false;
            });
        }
        
        // Show sync status message
        function showSyncStatus(message, type) {
            const statusDiv = document.getElementById('syncStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            
            // Set colors based on type
            switch(type) {
                case 'success':
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    break;
                case 'error':
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    break;
                case 'info':
                    statusDiv.style.background = '#d1ecf1';
                    statusDiv.style.color = '#0c5460';
                    break;
            }
            
            // Auto-hide after 5 seconds for success/info
            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // Update last sync display
        function updateLastSyncDisplay(isoDate) {
            const display = document.getElementById('lastSyncTime');
            if (isoDate) {
                const date = new Date(isoDate);
                display.textContent = `Last sync: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            }
        }
        
        // Auto-sync after saving orders (if cloud is configured)
        function autoSyncIfConfigured() {
            const config = JSON.parse(localStorage.getItem('miniAppConfig') || '{}');
            if (config.googleSheetsUrl && config.autoSync !== false) {
                // Debounce auto-sync to avoid too many requests
                clearTimeout(window.autoSyncTimeout);
                window.autoSyncTimeout = setTimeout(() => {
                    syncToCloud();
                }, 2000);
            }
        }
        
        // Auto-sync to cloud (silent - no UI updates, for background sync)
        async function autoSyncToCloud() {
            const config = JSON.parse(localStorage.getItem('miniAppConfig') || '{}');
            const url = config.googleSheetsUrl || DEFAULT_GOOGLE_SHEETS_URL;
            
            if (!url) {
                console.log('Auto-sync skipped: No cloud URL configured');
                return;
            }
            
            try {
                console.log('üîÑ Auto-syncing to cloud...');
                
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'syncOrders',
                        orders: orders
                    })
                });
                
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (parseError) {
                    console.error('Auto-sync parse error:', parseError);
                    return;
                }
                
                if (data.error) {
                    console.error('Auto-sync error:', data.error);
                } else {
                    // Update local orders with merged data
                    orders = data.orders;
                    localStorage.setItem('miniAppOrders', JSON.stringify(orders));
                    
                    // Update last sync time
                    config.lastSync = data.lastSync;
                    localStorage.setItem('miniAppConfig', JSON.stringify(config));
                    
                    // Update UI if sync display exists
                    const lastSyncDisplay = document.getElementById('lastSyncTime');
                    if (lastSyncDisplay) {
                        updateLastSyncDisplay(data.lastSync);
                    }
                    
                    console.log(`‚úÖ Auto-synced! ${data.mergedCount} orders in cloud`);
                }
            } catch (error) {
                console.error('Auto-sync failed:', error.message);
            }
        }
        
        // Load cloud config on page load
        loadCloudConfig();
        
        console.log('‚òÅÔ∏è Cloud sync functions loaded');
    </script>
</body>
</html>